# @package _global_

defaults:
  - default
  - override /model: fast3r

task_name: fast3r_local_head_better_scannetpp_and_arkit_pretrained_16views_large_co3d

data:
  num_views: 16
  num_views_val: 10
  num_workers: 0 # 0 for debugging
  pin_memory: false # for debugging
  data_module:
    batch_size_per_device: 1
    batch_size_per_device_val: 4
    train_datasets:
      - 10_000 @ Co3d_Multiview(split='train', num_views=${data.num_views}, window_degree_range=360, num_samples_per_window=100, ROOT='/fsx-cortex-datacache/jianingy/dust3r_data/co3d_all_seqs_per_category_subset_processed', aug_crop=16, mask_bg='rand', resolution=[(512, 384), (512, 336), (512, 288), (512, 256), (512, 160)], transform=ColorJitter)
      - 10_000 @ ScanNetpp_Multiview(split='train', num_views=${data.num_views}, window_size=${python_eval:"${data.num_views} + 1"}, num_samples_per_window=2, ROOT='${data.data_root}/scannetpp_processed', aug_crop=256, resolution=[(512, 384), (512, 336), (512, 288), (512, 256), (512, 160)], transform=ColorJitter)
      - 10_000 @ ARKitScenes_Multiview(split='train', num_views=${data.num_views}, window_size=${python_eval:"${data.num_views} * 5"}, num_samples_per_window=2, ROOT='${data.data_root}/arkitscenes_processed', aug_crop=256, resolution=[(512, 384), (512, 336), (512, 288), (512, 256), (512, 160)], transform=ColorJitter)
      - 10_000 @ Habitat_Multiview(1_000, split='train', num_views=${data.num_views}, ROOT='${data.data_root}/habitat_processed', aug_crop=16, resolution=[(512, 384), (512, 336), (512, 288), (512, 256), (512, 160)], transform=ColorJitter)
      # - 10_000 @ BlendMVS(split='train', num_frames=${data.num_views}, num_seq=200, ROOT='/fsx-cortex-datacache/jianingy/dust3r_data/datasets_raw/BlendedMVS', resolution=[(512, 384), (512, 336), (512, 288), (512, 256), (512, 160)])
    validation_datasets:
      - 100 @ Co3d_Multiview(split='test', num_views=${data.num_views_val}, window_degree_range=360, num_samples_per_window=100, ROOT='${data.data_root}/co3d_50_seqs_per_category_subset_processed', resolution=(512, 384), seed=777)
      - 100 @ MegaDepth_Multiview(split='val', num_views=${data.num_views_val}, window_size=${python_eval:"${data.num_views_val} * 2"}, num_samples_per_window=1, ROOT='${data.data_root}/megadepth_processed', resolution=(512, 384), seed=777)
      - 100 @ ScanNetpp_Multiview(split='train', num_views=${data.num_views_val}, window_size=${python_eval:"${data.num_views_val} * 2"}, num_samples_per_window=1, ROOT='${data.data_root}/scannetpp_processed', resolution=(512, 384), seed=777)
      - 100 @ ARKitScenes_Multiview(split='train', num_views=${data.num_views_val}, window_size=${python_eval:"${data.num_views_val} * 5"}, num_samples_per_window=1, ROOT='${data.data_root}/arkitscenes_processed', resolution=(512, 384), seed=777)
      - 100 @ Habitat_Multiview(100, split='val', num_views=${data.num_views_val}, ROOT='${data.data_root}/habitat_processed', resolution=(512, 384), seed=777)
      - 100 @ BlendMVS(split='test', num_frames=${data.num_views_val}, num_seq=200, ROOT='/fsx-cortex-datacache/jianingy/dust3r_data/datasets_raw/BlendedMVS', resolution=512, seed=777)
      - DTU(split='test', ROOT='${data.data_root}/dtu_test_mvsnet_release', resolution=512, num_seq=1, full_video=True, kf_every=15)
      # - 8 @ NRGBD(split='test', ROOT='${data.data_root}/neural_rgbd', num_frames=${data.num_views_val}, resolution=512, num_seq=1, full_video=False)
      # - 8 @ SevenScenes(split='test', ROOT='${data.data_root}/7_scenes_processed', num_frames=${data.num_views_val}, resolution=512, num_seq=1, full_video=False)

model:
  # pretrained: /opt/hpcaas/.mounts/fs-0565f60d669b6a2d3/home/jianingy/research/accel-cortex/dust3r/fast3r/logs/fast3r_local_head_habitat/runs/fast3r_local_head_habitat_4626119/checkpoints/last.ckpt
  pretrained: /opt/hpcaas/.mounts/fs-0565f60d669b6a2d3/home/jianingy/research/accel-cortex/dust3r/fast3r/logs/fast3r_local_head_habitat_better_scannetpp_8views/runs/fast3r_local_head_habitat_better_scannetpp_8views_4726417/checkpoints/last.ckpt
  net:
    head_args:
      with_local_head: True

  optimizer:
    _target_: torch.optim.AdamW
    _partial_: true
    lr: 1e-6
    betas: 
      - 0.9
      - 0.95
    weight_decay: 0.05
  
  scheduler:
    _target_: pl_bolts.optimizers.lr_scheduler.LinearWarmupCosineAnnealingLR
    _partial_: true
    warmup_epochs: 0
    max_epochs: ${trainer.max_epochs}
    eta_min: 1e-6

  train_criterion:
    _target_: src.dust3r.losses.ConfLossMultiviewV2
    pixel_loss:
      _target_: src.dust3r.losses.Regr3DMultiviewV3
      criterion:
        _target_: src.dust3r.losses.L21Loss
      norm_mode: avg_dis
    alpha: 0.2

  validation_criterion:
    _target_: src.dust3r.losses.ConfLossMultiviewV2
    pixel_loss:
      _target_: src.dust3r.losses.Regr3DMultiviewV3
      criterion:
        _target_: src.dust3r.losses.L21Loss
      norm_mode: avg_dis
    alpha: 0.2
